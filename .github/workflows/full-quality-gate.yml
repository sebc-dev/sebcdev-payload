# .github/workflows/full-quality-gate.yml
# Full Quality Gate - Runs ALL required checks
#
# Triggers:
#   - workflow_dispatch: Manual trigger only
#
# This workflow orchestrates all required checks before merge.
# It calls the individual workflows and reports a single status.

name: Full Quality Gate

on:
  workflow_dispatch:
    inputs:
      run_mutation_tests:
        description: 'Run Stryker mutation testing (CPU intensive, optional)'
        required: false
        default: false
        type: boolean
      mutation_report_retention_days:
        description: 'Mutation report retention (days)'
        required: false
        default: '5'
        type: choice
        options:
          - '3'
          - '5'
          - '7'
          - '14'

# Minimal permissions for the orchestrator workflow
permissions:
  contents: read

jobs:
  # ============================================
  # Core Checks (ESLint, Prettier, Type Sync, Build)
  # ============================================
  core-checks:
    name: Core Checks
    uses: ./.github/workflows/core-checks.yml
    secrets: inherit

  # ============================================
  # Security (Socket.dev, Knip)
  # ============================================
  security:
    name: Security
    uses: ./.github/workflows/security.yml
    secrets: inherit

  # ============================================
  # Tests (Unit, Integration, E2E)
  # ============================================
  tests:
    name: Tests
    uses: ./.github/workflows/tests.yml
    secrets: inherit

  # ============================================
  # Architecture (dependency-cruiser)
  # ============================================
  architecture:
    name: Architecture
    uses: ./.github/workflows/architecture.yml
    secrets: inherit

  # ============================================
  # Mutation Testing (Optional)
  # ============================================
  mutation:
    name: Mutation Testing
    if: ${{ github.event.inputs.run_mutation_tests == 'true' }}
    uses: ./.github/workflows/mutation.yml
    with:
      report_retention_days: ${{ github.event.inputs.mutation_report_retention_days }}
    secrets: inherit

  # ============================================
  # Summary - All checks must pass
  # ============================================
  summary:
    name: Quality Gate Summary
    needs: [core-checks, security, tests, architecture]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Check Results
        run: |
          echo "## Full Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check each job result
          CORE_RESULT="${{ needs.core-checks.result }}"
          SECURITY_RESULT="${{ needs.security.result }}"
          TESTS_RESULT="${{ needs.tests.result }}"
          ARCH_RESULT="${{ needs.architecture.result }}"

          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "$CORE_RESULT" = "success" ]; then
            echo "| Core Checks | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Core Checks | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$SECURITY_RESULT" = "success" ]; then
            echo "| Security | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Security | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$TESTS_RESULT" = "success" ]; then
            echo "| Tests | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Tests | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$ARCH_RESULT" = "success" ]; then
            echo "| Architecture | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Architecture | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Fail if any required job failed
          if [ "$CORE_RESULT" != "success" ] || [ "$SECURITY_RESULT" != "success" ] || [ "$TESTS_RESULT" != "success" ] || [ "$ARCH_RESULT" != "success" ]; then
            echo "❌ **Quality Gate Failed** - Some checks did not pass." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "✅ **Quality Gate Passed** - All required checks passed." >> $GITHUB_STEP_SUMMARY
