# .github/workflows/deploy.yml
# Deploy - Cloudflare Workers deployment
#
# Triggers:
#   - workflow_dispatch: Manual trigger only
#
# Prerequisites:
#   - Full Quality Gate must pass before deploying (enforced by branch protection)
#
# This workflow handles D1 migrations and Cloudflare Workers deployment.

name: Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Cloudflare
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ============================================
      # D1 Migrations
      # ============================================

      - name: Run D1 Migrations
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          NODE_ENV: production
        run: |
          echo "::group::Running D1 Migrations"
          pnpm payload migrate
          echo "::endgroup::"
          echo "::notice::✅ D1 migrations completed successfully"

      # ============================================
      # Cloudflare Workers Deploy
      # ============================================

      - name: Deploy to Cloudflare Workers
        id: deploy
        uses: cloudflare/wrangler-action@392082e81ffbcb9ebdde27400634aa004b35ea37 # v3.14.0
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
        env:
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}

      - name: Output Deployment URL
        run: |
          echo "## Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: ${{ steps.deploy.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # Validation
      # ============================================

      - name: Wait for Deployment Availability
        run: |
          URL="${{ steps.deploy.outputs.deployment-url }}"
          echo "Waiting for $URL to become available..."

          MAX_RETRIES=30
          RETRY_INTERVAL=2

          for i in $(seq 1 $MAX_RETRIES); do
            if curl -s -f -o /dev/null "$URL"; then
              echo "::notice::✅ Deployment is live at $URL"
              exit 0
            fi
            echo "Attempt $i/$MAX_RETRIES - Waiting ${RETRY_INTERVAL}s..."
            sleep $RETRY_INTERVAL
          done

          echo "::error::Deployment URL not reachable after $((MAX_RETRIES * RETRY_INTERVAL))s"
          exit 1

      - name: Smoke Test
        run: |
          URL="${{ steps.deploy.outputs.deployment-url }}"

          echo "::group::Testing Homepage"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ Homepage returned 200 OK"
          else
            echo "::warning::Homepage returned $HTTP_STATUS (expected 200)"
          fi
          echo "::endgroup::"

          echo "::group::Testing Admin Panel"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/admin")
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "302" ]; then
            echo "✅ Admin panel accessible (status: $HTTP_STATUS)"
          else
            echo "::warning::Admin panel returned $HTTP_STATUS"
          fi
          echo "::endgroup::"
