# .github/workflows/deploy.yml
# Deploy - Cloudflare Workers deployment
#
# Triggers:
#   - workflow_dispatch: Manual trigger only
#
# Prerequisites:
#   - Full Quality Gate must pass before deploying (enforced by branch protection)
#
# This workflow handles D1 migrations and Cloudflare Workers deployment.

name: Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Cloudflare
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ============================================
      # Build
      # ============================================

      - name: Build Next.js and OpenNext
        env:
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
        run: |
          echo "::group::Building Next.js application"
          pnpm build
          echo "::endgroup::"
          echo "::notice::✅ Build completed successfully"

      # ============================================
      # D1 Migrations
      # ============================================

      - name: Run D1 Migrations
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          NODE_ENV: production
        run: |
          echo "::group::Running D1 Migrations"
          pnpm payload migrate
          echo "::endgroup::"
          echo "::notice::✅ D1 migrations completed successfully"

      # ============================================
      # Cloudflare Workers Deploy
      # ============================================

      - name: Deploy to Cloudflare Workers
        id: deploy
        uses: cloudflare/wrangler-action@392082e81ffbcb9ebdde27400634aa004b35ea37 # v3.14.0
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
        env:
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}

      - name: Output Deployment URL
        run: |
          echo "## Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: ${{ steps.deploy.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # Validation
      # ============================================

      - name: Wait for Deployment Availability
        run: |
          URL="${{ steps.deploy.outputs.deployment-url }}"
          echo "Waiting for $URL to become available..."

          MAX_RETRIES=30
          RETRY_INTERVAL=2

          for i in $(seq 1 $MAX_RETRIES); do
            if curl -s -f -o /dev/null "$URL"; then
              echo "::notice::✅ Deployment is live at $URL"
              exit 0
            fi
            echo "Attempt $i/$MAX_RETRIES - Waiting ${RETRY_INTERVAL}s..."
            sleep $RETRY_INTERVAL
          done

          echo "::error::Deployment URL not reachable after $((MAX_RETRIES * RETRY_INTERVAL))s"
          exit 1

      - name: Smoke Test
        run: |
          URL="${{ steps.deploy.outputs.deployment-url }}"
          TMPDIR=$(mktemp -d)
          trap "rm -rf $TMPDIR" EXIT

          echo "::group::Testing Homepage"
          HOMEPAGE_FILE="$TMPDIR/homepage.html"
          HTTP_STATUS=$(curl -s -o "$HOMEPAGE_FILE" -w "%{http_code}" "$URL")

          if [ "$HTTP_STATUS" = "200" ]; then
            # Verify content is not empty and contains HTML
            if [ -s "$HOMEPAGE_FILE" ] && grep -qi "<html" "$HOMEPAGE_FILE"; then
              echo "✅ Homepage returned 200 OK with valid HTML content"
            else
              echo "::warning::Homepage returned 200 but content appears invalid"
            fi
          else
            echo "::error::Homepage returned $HTTP_STATUS (expected 200)"
            exit 1
          fi
          echo "::endgroup::"

          echo "::group::Testing Admin Panel"
          ADMIN_FILE="$TMPDIR/admin.html"
          HTTP_STATUS=$(curl -s -L -o "$ADMIN_FILE" -w "%{http_code}" "$URL/admin")

          if [ "$HTTP_STATUS" = "200" ]; then
            # Admin should show login form or dashboard
            if [ -s "$ADMIN_FILE" ] && grep -qiE "(login|payload|admin)" "$ADMIN_FILE"; then
              echo "✅ Admin panel accessible with expected content"
            else
              echo "::warning::Admin panel returned 200 but content appears unexpected"
            fi
          elif [ "$HTTP_STATUS" = "302" ]; then
            echo "✅ Admin panel redirecting (expected for auth)"
          else
            echo "::error::Admin panel returned $HTTP_STATUS"
            exit 1
          fi
          echo "::endgroup::"
