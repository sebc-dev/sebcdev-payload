# .github/workflows/tests.yml
# Tests - Unit, Integration, and E2E tests
#
# Triggers:
#   - workflow_dispatch: Manual trigger only
#   - workflow_call: Can be called by other workflows (full-quality-gate)
#
# Required for merge but must be triggered manually.

name: Tests

on:
  workflow_dispatch:
  workflow_call:

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Unit Tests
        run: pnpm test:unit --coverage

      - name: Coverage Summary
        if: always()
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "## Unit Test Coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat coverage/coverage-summary.json | jq -r '.total | "| Metric | Coverage |\n|--------|----------|\n| Lines | \(.lines.pct)% |\n| Statements | \(.statements.pct)% |\n| Functions | \(.functions.pct)% |\n| Branches | \(.branches.pct)% |"' >> $GITHUB_STEP_SUMMARY
          fi

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest

    permissions:
      contents: read

    env:
      HAS_PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET != '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate CI Payload Secret
        if: env.HAS_PAYLOAD_SECRET != 'true'
        run: echo "PAYLOAD_SECRET_CI=$(openssl rand -hex 32)" >> "$GITHUB_ENV"

      - name: Integration Tests
        env:
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET || env.PAYLOAD_SECRET_CI }}
        run: pnpm test:int

  # E2E tests disabled - overkill for a blog, too flaky in CI
  # Tests remain available locally: pnpm test:e2e
  # Rationale:
  #   - Unit + Integration tests provide sufficient coverage
  #   - E2E tests had infrastructure issues (Payload/Wrangler/Next.js)
  #   - SEO and accessibility can be validated manually or via simpler tools
  #
  # e2e-tests:
  #   name: E2E Tests
  #   runs-on: ubuntu-latest
  #
  #   permissions:
  #     contents: read
  #
  #   env:
  #     HAS_PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET != '' }}
  #
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
  #
  #     - name: Setup pnpm
  #       uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
  #       with:
  #         version: 9
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
  #       with:
  #         node-version: '20'
  #         cache: 'pnpm'
  #
  #     - name: Install dependencies
  #       run: pnpm install --frozen-lockfile
  #
  #     - name: Generate CI Payload Secret
  #       if: env.HAS_PAYLOAD_SECRET != 'true'
  #       run: echo "PAYLOAD_SECRET_CI=$(openssl rand -hex 32)" >> "$GITHUB_ENV"
  #
  #     - name: Get Playwright Version
  #       id: playwright-version
  #       run: echo "version=$(pnpm exec playwright --version | head -1)" >> $GITHUB_OUTPUT
  #
  #     - name: Cache Playwright Browsers
  #       uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
  #       id: playwright-cache
  #       with:
  #         path: ~/.cache/ms-playwright
  #         key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}
  #
  #     - name: Install Playwright Browsers
  #       if: steps.playwright-cache.outputs.cache-hit != 'true'
  #       run: pnpm exec playwright install --with-deps chromium
  #
  #     - name: E2E Tests
  #       env:
  #         PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET || env.PAYLOAD_SECRET_CI }}
  #       run: pnpm test:e2e
  #       timeout-minutes: 15
  #
  #     - name: Upload E2E Test Artifacts
  #       if: failure()
  #       uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
  #       with:
  #         name: playwright-report
  #         path: |
  #           test-results/
  #           playwright-report/
  #         retention-days: 7
