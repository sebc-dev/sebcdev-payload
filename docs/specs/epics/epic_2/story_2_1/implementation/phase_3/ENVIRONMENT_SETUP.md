# Phase 3 - Environment Setup

This guide covers all environment setup needed for Phase 3 (Articles Collection).

---

## üìã Prerequisites

### Previous Phases

- [ ] **Phase 1 (i18n Configuration)** - MUST be completed
  - `localization` configured in `payload.config.ts`
  - FR and EN locales available
  - Language toggle functional in admin

- [ ] **Phase 2 (Categories & Tags)** - MUST be completed
  - Categories collection exists and is functional
  - Tags collection exists and is functional
  - Test data: At least 1 category and 2-3 tags created for testing

- [ ] **Existing Collections** - Required for relations
  - `users` collection exists (from initial Payload setup)
  - `media` collection exists (from initial Payload setup)

### Tools Required

- [ ] Node.js 18.20.2+ or 20.9.0+ installed
- [ ] pnpm 9+ or 10+ installed
- [ ] TypeScript 5.7.3 installed (project dependency)
- [ ] Git installed (for commits)

### Services Required

- [ ] **Cloudflare D1 database** running locally (via Wrangler)
  - Wrangler automatically binds D1 in development
  - Verify: `pnpm dev` should connect to local D1 without errors

- [ ] **Payload CMS** configured and running
  - Verify: Can access http://localhost:3000/admin
  - Can login with admin user

---

## üì¶ Dependencies Installation

### Verify Existing Dependencies

All necessary dependencies for Phase 3 should already be installed from the initial project setup. Verify:

```bash
# Check package.json for required dependencies
cat package.json | grep -E "payload|@payloadcms"

# Should show:
# - payload: 3.63.0
# - @payloadcms/next: 3.63.0
# - @payloadcms/richtext-lexical: 3.63.0
# - @payloadcms/db-d1-sqlite: 3.63.0
```

### No New Packages Required

Phase 3 does not require any new npm packages. The Articles collection uses:
- **Payload Core** (already installed)
- **Lexical Editor** (already installed via `@payloadcms/richtext-lexical`)
- **D1 Adapter** (already installed via `@payloadcms/db-d1-sqlite`)

If for any reason dependencies are missing:

```bash
# Reinstall all dependencies
pnpm install
```

---

## üîß Environment Variables

### Required Variables

Verify these environment variables exist in `.env.local` or `.env`:

```env
# Payload Secret (required)
PAYLOAD_SECRET=your-secret-key-here

# Cloudflare Environment (for deployment, not required for dev)
CLOUDFLARE_ENV=development
```

### Verification

```bash
# Check if PAYLOAD_SECRET is set
grep PAYLOAD_SECRET .env.local || grep PAYLOAD_SECRET .env

# If not found, generate one:
openssl rand -hex 32

# Add to .env.local:
echo "PAYLOAD_SECRET=$(openssl rand -hex 32)" >> .env.local
```

### No Additional Variables Needed

Phase 3 does not require any new environment variables. The Articles collection operates entirely within the existing Payload infrastructure.

---

## üóÑÔ∏è Database Setup

### Verify D1 Database

Phase 2 migrations should have already created the `categories` and `tags` tables. Verify:

```bash
# Start dev server (Wrangler binds local D1)
pnpm dev

# In another terminal, check D1 tables
pnpm exec wrangler d1 execute D1 --local --command "SELECT name FROM sqlite_master WHERE type='table';"

# Expected tables (from Payload + Phase 1 & 2):
# - payload_preferences
# - users
# - media
# - categories
# - tags
# - (other Payload system tables)
```

### Database Migrations

Phase 3 will create new database tables for the `articles` collection. The migration will be auto-generated by Payload after creating the collection.

**Important**: Do NOT manually create the `articles` table. Payload's migration system will handle this in **Commit 2** (after Articles collection is defined).

### Test Data for Relations

Before implementing Phase 3, ensure you have test data in the database:

#### Create Test User (if needed)

```bash
# Start dev server
pnpm dev

# Navigate to http://localhost:3000/admin/collections/users
# Create a test user for article authorship:
# - Email: test.author@example.com
# - Password: TestPassword123!
# - Role: (whatever roles are configured)

# Note the user ID for tests
```

#### Create Test Category

```bash
# Navigate to http://localhost:3000/admin/collections/categories
# Create at least one category:
# - Name (FR): "Technologie"
# - Name (EN): "Technology"
# - Slug: "technology"
# - Color: "#3B82F6"
# - Icon: "tech"

# Note the category ID for tests
```

#### Create Test Tags

```bash
# Navigate to http://localhost:3000/admin/collections/tags
# Create 2-3 tags:
# 1. Name (FR): "JavaScript", Name (EN): "JavaScript", Slug: "javascript"
# 2. Name (FR): "React", Name (EN): "React", Slug: "react"
# 3. Name (FR): "TypeScript", Name (EN): "TypeScript", Slug: "typescript"

# Note tag IDs for tests
```

#### Upload Test Media

```bash
# Navigate to http://localhost:3000/admin/collections/media
# Upload a test image (any image file, e.g., 1200x630 for featured images)
# This will test R2 storage integration

# Note the media ID for tests
```

---

## ‚úÖ Connection Tests

### Test Payload Access

```bash
# Start dev server
pnpm dev

# Should see output like:
# [INFO] Payload Admin URL: http://localhost:3000/admin
# [INFO] Next.js started on http://localhost:3000
```

Open browser to http://localhost:3000/admin and verify:
- [ ] Admin panel loads
- [ ] Can login
- [ ] Categories collection visible
- [ ] Tags collection visible
- [ ] Users collection visible
- [ ] Media collection visible

**Expected Result**: All collections from Phase 1 and 2 are accessible

### Test Database Connectivity

```bash
# Query categories (from Phase 2)
pnpm exec wrangler d1 execute D1 --local --command "SELECT * FROM categories LIMIT 1;"

# Should return at least one category row if test data was created
```

**Expected Result**: Database queries execute successfully

### Test Type Generation

```bash
# Regenerate Payload types
pnpm generate:types:payload

# Should complete without errors and update src/payload-types.ts
```

**Expected Result**: Types regenerate successfully, file `src/payload-types.ts` updated

---

## üö® Troubleshooting

### Issue: "Payload Secret Not Found"

**Symptoms**:
- Dev server fails to start
- Error: "PAYLOAD_SECRET environment variable is required"

**Solutions**:
1. Check `.env.local` or `.env` file exists in project root
2. Verify `PAYLOAD_SECRET` is set:
   ```bash
   grep PAYLOAD_SECRET .env.local
   ```
3. If missing, generate and add:
   ```bash
   echo "PAYLOAD_SECRET=$(openssl rand -hex 32)" >> .env.local
   ```
4. Restart dev server:
   ```bash
   pnpm dev
   ```

**Verify Fix**: Dev server starts without errors

---

### Issue: Categories or Tags Collection Not Found

**Symptoms**:
- Admin UI doesn't show Categories or Tags collections
- Error when trying to access `/admin/collections/categories`

**Solutions**:
1. Verify Phase 2 is complete:
   ```bash
   cat docs/specs/epics/epic_2/story_2_1/implementation/PHASES_PLAN.md
   # Check if Phase 2 is marked complete
   ```
2. Check `payload.config.ts` includes Categories and Tags:
   ```bash
   grep -E "Categories|Tags" src/payload.config.ts
   ```
3. If missing, Phase 2 must be completed before starting Phase 3
4. Regenerate types and restart:
   ```bash
   pnpm generate:types:payload
   pnpm dev
   ```

**Verify Fix**: Categories and Tags appear in admin sidebar

---

### Issue: Database Migration Fails

**Symptoms**:
- Migration command errors
- Tables not created

**Solutions**:
1. Check D1 database is running:
   ```bash
   pnpm dev
   # Wrangler should show D1 binding in logs
   ```
2. Reset local database if corrupted (WARNING: deletes all data):
   ```bash
   # Stop dev server first
   rm -rf .wrangler/state/v3/d1/miniflare-D1/*
   pnpm dev
   # Migrations will re-run
   ```
3. Manually apply migration (Payload 3.x uses local migrations in dev):
   ```bash
   pnpm payload migrate
   ```

**Verify Fix**: Dev server starts, tables created successfully

---

### Issue: Type Generation Fails

**Symptoms**:
- `pnpm generate:types:payload` errors
- `src/payload-types.ts` not updated

**Solutions**:
1. Clear Payload cache:
   ```bash
   rm -rf .payload
   ```
2. Clear Next.js cache:
   ```bash
   rm -rf .next
   ```
3. Ensure payload.config.ts is valid:
   ```bash
   pnpm exec tsc --noEmit
   # Should have no errors
   ```
4. Re-run type generation:
   ```bash
   pnpm generate:types:payload
   ```

**Verify Fix**: Types regenerate without errors, file updated with latest timestamp

---

### Issue: Admin UI Login Fails

**Symptoms**:
- Cannot login to admin panel
- Invalid credentials error

**Solutions**:
1. Verify user exists in database:
   ```bash
   pnpm exec wrangler d1 execute D1 --local --command "SELECT email FROM users;"
   ```
2. If no users exist, create initial user:
   ```bash
   # Navigate to http://localhost:3000/admin
   # First-time setup should prompt to create admin user
   # OR use Payload seed script if configured
   ```
3. Reset password (if configured):
   ```bash
   # Use Payload's password reset feature in admin UI
   ```

**Verify Fix**: Can login to admin panel successfully

---

## üìù Setup Checklist

Complete this checklist before starting Phase 3 implementation:

### Prerequisites
- [ ] Node.js 18.20.2+ or 20.9.0+ installed
- [ ] pnpm 9+ installed
- [ ] Git configured

### Previous Phases
- [ ] Phase 1 (i18n) completed and validated
- [ ] Phase 2 (Categories & Tags) completed and validated

### Environment
- [ ] `.env.local` or `.env` file exists
- [ ] `PAYLOAD_SECRET` environment variable set
- [ ] Dev server starts without errors (`pnpm dev`)

### Database
- [ ] D1 database accessible
- [ ] Categories table exists (from Phase 2)
- [ ] Tags table exists (from Phase 2)
- [ ] Users table exists (initial setup)
- [ ] Media table exists (initial setup)

### Test Data
- [ ] At least 1 test user created (for author relation)
- [ ] At least 1 category created (for category relation)
- [ ] At least 2-3 tags created (for tags relation)
- [ ] At least 1 media file uploaded (for featuredImage relation)

### Tools & Verification
- [ ] Type generation works (`pnpm generate:types:payload`)
- [ ] TypeScript compiles (`pnpm exec tsc --noEmit`)
- [ ] Linter runs (`pnpm lint`)
- [ ] Admin UI accessible (http://localhost:3000/admin)
- [ ] Can login to admin panel
- [ ] Categories and Tags collections visible in admin

---

## üöÄ Ready to Start

**If all checklist items above are checked, your environment is ready for Phase 3 implementation!**

**Next Steps**:

1. Read [IMPLEMENTATION_PLAN.md](./IMPLEMENTATION_PLAN.md) to understand the 5 atomic commits
2. Follow [COMMIT_CHECKLIST.md](./COMMIT_CHECKLIST.md) for step-by-step implementation
3. Start with Commit 1: Create `calculateReadingTime` hook

**Commands to keep handy during implementation**:

```bash
# Type checking
pnpm exec tsc --noEmit

# Regenerate types
pnpm generate:types:payload

# Run unit tests
pnpm test:unit

# Run integration tests
pnpm test:int

# Lint
pnpm lint

# Dev server
pnpm dev
```

---

**Environment setup complete! üéâ**
