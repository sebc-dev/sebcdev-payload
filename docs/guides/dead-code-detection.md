# Dead Code Detection & Type Sync Guide

## Overview

This project uses **Knip** for dead code detection and **Payload type sync** validation
to ensure code quality and type safety.

## Quick Commands

```bash
# Run Knip (full analysis)
pnpm exec knip

# Run Knip (production mode - CI)
pnpm exec knip --production

# Generate Payload types
pnpm generate:types:payload

# Check if types are synced
git diff --exit-code src/payload-types.ts
```

## Knip Configuration

- **Config file**: `knip.json`
- **Mode in CI**: `--production` (ignores tests and devDependencies)

### Entry Points

Knip needs explicit entry points for convention-based frameworks:

| Entry Point           | Framework      | Purpose                |
| --------------------- | -------------- | ---------------------- |
| `next.config.ts`      | Next.js        | Framework config       |
| `payload.config.ts`   | Payload CMS    | CMS entry point        |
| `src/middleware.ts`   | Next.js        | Request middleware     |
| `src/instrumentation.ts` | Next.js     | OpenTelemetry hooks    |

### Ignored Files

| Pattern                | Reason                               |
| ---------------------- | ------------------------------------ |
| `src/payload-types.ts` | Auto-generated by Payload            |
| `drizzle/migrations/**` | SQL migrations, never imported      |
| `public/**`            | Static assets                        |

## Payload Type Sync

Payload CMS generates TypeScript types from your collection definitions.
These types must stay synchronized with your config.

### When to Regenerate

Regenerate types after:
- Adding/removing collection fields
- Changing field types
- Modifying relationships
- Updating hooks that affect types

### How to Regenerate

```bash
pnpm generate:types:payload
git add src/payload-types.ts
git commit -m "ðŸ”§ Regenerate Payload types"
```

## Troubleshooting

### Knip Reports False Positives

If Knip incorrectly reports files as unused:

1. Check if it's a framework convention (should be auto-detected)
2. Add to `entry` in `knip.json` if legitimately used
3. Add to `ignore` with a comment explaining why

Example:
```json
{
  "entry": [
    "src/my-custom-entry.ts"
  ],
  "ignore": [
    "src/special-case.ts"
  ]
}
```

### Knip is Slow

Run in production mode (faster):
```bash
pnpm exec knip --production
```

### Type Generation Fails

Ensure `PAYLOAD_SECRET` is set:
```bash
export PAYLOAD_SECRET="your-32-char-secret-here!!!!!!!"
pnpm generate:types:payload
```

### Types Out of Sync in CI

If CI reports "types are out of sync":
```bash
pnpm generate:types:payload
git add src/payload-types.ts
git commit -m "ðŸ”§ Regenerate Payload types"
git push
```
